<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Redirecting...</title>
</head>
<body>
  <h1 style="text-align:center">جارٍ تحديد أقرب فرع لك...</h1>

  <script>
    // Branch locations and URLs
    const branches = [
      { name: "Makrmyah", lat: 16.598503, lon: 42.964406, url: "https://maps.app.goo.gl/5fynvoyMhjbRcMg19" },
      { name: "Dehmah", lat: 16.653945, lon: 43.136119, url: "https://maps.app.goo.gl/8hp3eC6Ls4K44ZVx9" },
      { name: "Sawarmah", lat: 16.596058, lon: 42.957103, url: "https://maps.app.goo.gl/wzD448BCkEFLLYFw5" },
      { name: "Kharsh", lat: 16.614381, lon: 43.002194, url: "https://maps.app.goo.gl/MqZUKq72ss8qowEi6" },
      { name: "Mojour", lat: 16.576167, lon: 43.038331, url: "https://maps.app.goo.gl/iutEW2hDYLCuACX17" }
    ];

    function getDistance(lat1, lon1, lat2, lon2) {
      const toRad = deg => deg * Math.PI / 180;
      const R = 6371; // km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function redirectToNearestBranch(position) {
      const userLat = position.coords.latitude;
      const userLon = position.coords.longitude;

      let nearest = branches[0];
      let minDistance = getDistance(userLat, userLon, nearest.lat, nearest.lon);

      for (let i = 1; i < branches.length; i++) {
        const dist = getDistance(userLat, userLon, branches[i].lat, branches[i].lon);
        if (dist < minDistance) {
          nearest = branches[i];
          minDistance = dist;
        }
      }

      // Redirect
      window.location.href = nearest.url;
    }

    function handleError() {
      document.body.innerHTML = "<h2 style='text-align:center'>لم نتمكن من تحديد موقعك، يرجى السماح بمشاركة الموقع أو اختيار الفرع يدوياً.</h2>";
    }

    // Ask for location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(redirectToNearestBranch, handleError);
    } else {
      handleError();
    }
  </script>
</body>
</html>